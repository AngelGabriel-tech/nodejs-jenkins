pipeline {
    agent any

    stages {
        stage('Install') {
            steps {
                echo 'ðŸ“¦ Installing dependencies...'
                sh 'npm install --no-audit --no-fund'
            }
        }

        stage('Start') {
            steps {
                echo 'ðŸš€ Starting the Node.js application...'
                // Start in background and redirect logs
                sh '''
                    nohup npm start > server.log 2>&1 &
                    sleep 3
                    echo "=== Server log output ==="
                    tail -n 20 server.log
                '''
            }
        }

        stage('Stop') {
            steps {
                echo 'ðŸ›‘ Stopping the Node.js application...'
                // Stop gracefully if npm stop exists, else kill process manually
                sh '''
                    npm stop || pkill -f "node app/server.js" || true
                    echo "=== Server stopped successfully ==="
                '''
            }
        }
    }

    post {
        always {
            echo 'ðŸ§¹ Cleanup: ensuring the app is stopped'
            sh 'npm stop || pkill -f "node app/server.js" || true'
            echo 'ðŸ“œ Displaying final log snapshot:'
            sh 'tail -n 30 server.log || true'
        }
    }
}
