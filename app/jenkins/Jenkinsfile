pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo 'Installing dependencies (linux-only)'
                sh "npm install --no-audit --no-fund"
            }
        }

                stage('Start') {
                        steps {
                                echo 'Starting application (background)'
                                sh '''
                                    mkdir -p tmp
                                    nohup npm start > server.log 2>&1 &
                                    echo $! > tmp/server.pid
                                    sleep 2
                                '''
                        }
                }

        stage('Deploy') {
            steps {
                echo 'Deploy step: stopping the application'
                sh '''
                  npm stop || ( [ -f tmp/server.pid ] && kill -TERM $(cat tmp/server.pid) ) || true
                '''
            }
        }
    }
    post {
        always {
            echo 'Post: ensure npm stop is called'
            sh 'npm stop || true'
        }
    }
}
